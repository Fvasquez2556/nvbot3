# Ejemplo de c√≥mo modificar tu pipeline existente de NvBot3
# para incluir tracking autom√°tico de se√±ales

"""
ANTES DE APLICAR ESTAS MODIFICACIONES:
1. Completa el entrenamiento de tus modelos (model_trainer.py)
2. Ejecuta el script de integraci√≥n (integrate_feedback_system.py)
3. Instala las dependencias adicionales (pip install flask flask-socketio)

DESPU√âS DE APLICAR ESTAS MODIFICACIONES:
Tendr√°s un sistema completo que:
- Detecta oportunidades como siempre
- Autom√°ticamente guarda cada se√±al para tracking
- Monitorea precios en tiempo real  
- Permite retroalimentaci√≥n via web
- Mejora autom√°ticamente con machine learning
"""

# ==================================================================================
# EJEMPLO 1: Modificaci√≥n de tu funci√≥n principal de predicci√≥n
# ==================================================================================

# TU C√ìDIGO ORIGINAL (simplificado para ejemplo)
def tu_funcion_prediccion_original(symbol, market_data):
    """Tu funci√≥n existente que genera predicciones"""
    
    # Tu l√≥gica existente...
    features = calculate_features(market_data)  # Tus 151 features
    
    # Tus modelos entrenados
    momentum_pred = momentum_model.predict(features)
    rebound_pred = rebound_model.predict(features) 
    regime_pred = regime_model.predict(features)
    
    # Tu l√≥gica de decisi√≥n existente
    if momentum_pred > 0.05 and confidence > 0.75:
        prediction = {
            'type': 'momentum',
            'change': momentum_pred,
            'confidence': confidence
        }
        return prediction
    
    return None

# TU C√ìDIGO MODIFICADO (con tracking autom√°tico)
def tu_funcion_prediccion_modificada(symbol, market_data):
    """Tu funci√≥n existente + tracking autom√°tico"""
    
    # Tu l√≥gica existente exactamente igual...
    features = calculate_features(market_data)
    momentum_pred = momentum_model.predict(features)
    rebound_pred = rebound_model.predict(features) 
    regime_pred = regime_model.predict(features)
    
    # Tu l√≥gica de decisi√≥n existente
    if momentum_pred > 0.05 and confidence > 0.75:
        prediction = {
            'type': 'momentum',
            'change': momentum_pred,
            'confidence': confidence
        }
        
        # ====== NUEVA L√çNEA: Guardar para tracking ======
        save_prediction_to_tracker(symbol, prediction, market_data['close'])
        # ===============================================
        
        return prediction
    
    return None

# ==================================================================================
# EJEMPLO 2: Modificaci√≥n de tu loop principal de an√°lisis
# ==================================================================================

# TU LOOP ORIGINAL
async def tu_loop_principal_original():
    """Tu loop existente que analiza m√∫ltiples s√≠mbolos"""
    
    symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT']  # Tus s√≠mbolos
    
    while True:
        for symbol in symbols:
            try:
                # Obtener datos de mercado
                market_data = get_market_data(symbol)
                
                # Generar predicci√≥n
                prediction = tu_funcion_prediccion_original(symbol, market_data)
                
                if prediction:
                    print(f"üéØ Se√±al detectada en {symbol}: {prediction}")
                    # Aqu√≠ podr√≠as enviar notificaci√≥n, etc.
                
            except Exception as e:
                print(f"Error con {symbol}: {e}")
        
        await asyncio.sleep(60)  # Esperar 1 minuto

# TU LOOP MODIFICADO (con tracking autom√°tico)
async def tu_loop_principal_modificado():
    """Tu loop existente + tracking autom√°tico"""
    
    symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT']
    
    while True:
        for symbol in symbols:
            try:
                # Tu l√≥gica existente exactamente igual...
                market_data = get_market_data(symbol)
                prediction = tu_funcion_prediccion_modificada(symbol, market_data)
                
                if prediction:
                    print(f"üéØ Se√±al detectada en {symbol}: {prediction}")
                    
                    # ===== L√çNEAS NUEVAS: Feedback autom√°tico =====
                    print(f"üìä Se√±al guardada para tracking y retroalimentaci√≥n")
                    print(f"üåê Visible en dashboard: http://localhost:5000")
                    # ===============================================
                
            except Exception as e:
                print(f"Error con {symbol}: {e}")
        
        await asyncio.sleep(60)

# ==================================================================================
# EJEMPLO 3: C√≥mo a√±adir tracking a diferentes tipos de se√±al
# ==================================================================================

class SignalGenerator:
    """Ejemplo de c√≥mo organizar tu generador de se√±ales con tracking"""
    
    def __init__(self):
        # Tus modelos existentes
        self.momentum_model = load_model('momentum')
        self.rebound_model = load_model('rebound') 
        self.regime_model = load_model('regime')
        
        # Nuevo: tracker de se√±ales
        from web_dashboard.database.signal_tracker import SignalTracker
        self.tracker = SignalTracker()
    
    def detect_momentum(self, symbol, features, current_price):
        """Detecta se√±ales de momentum (tu l√≥gica existente)"""
        
        prediction = self.momentum_model.predict(features)
        confidence = calculate_confidence(prediction)
        
        if prediction >= 0.05 and confidence >= 0.75:
            
            signal_data = {
                'type': 'momentum_alto',
                'predicted_change': prediction,
                'confidence': confidence,
                'entry_price': current_price,
                'expected_timeframe_minutes': 240  # 4 horas
            }
            
            # Guardar autom√°ticamente
            signal_id = self.tracker.save_new_signal(symbol, signal_data)
            
            return {
                'signal_id': signal_id,
                'type': 'momentum_alto',
                'change': prediction,
                'confidence': confidence
            }
        
        return None
    
    def detect_rebound(self, symbol, features, current_price):
        """Detecta rebotes peque√±os (tu l√≥gica existente)"""
        
        prediction = self.rebound_model.predict(features)
        confidence = calculate_confidence(prediction)
        
        if 0.01 <= prediction <= 0.03 and confidence >= 0.70:
            
            signal_data = {
                'type': 'rebote_peque√±o',
                'predicted_change': prediction,
                'confidence': confidence,
                'entry_price': current_price,
                'expected_timeframe_minutes': 120  # 2 horas
            }
            
            signal_id = self.tracker.save_new_signal(symbol, signal_data)
            
            return {
                'signal_id': signal_id,
                'type': 'rebote_peque√±o', 
                'change': prediction,
                'confidence': confidence
            }
        
        return None
    
    def detect_regime_change(self, symbol, features, current_price):
        """Detecta cambios de r√©gimen (tu l√≥gica existente)"""
        
        regime_pred = self.regime_model.predict(features)
        confidence = calculate_confidence(regime_pred)
        
        if regime_pred == 'bullish' and confidence >= 0.80:
            
            signal_data = {
                'type': 'cambio_regimen',
                'predicted_change': 0.0,  # R√©gimen no predice cambio espec√≠fico
                'confidence': confidence,
                'entry_price': current_price,
                'expected_timeframe_minutes': 480  # 8 horas
            }
            
            signal_id = self.tracker.save_new_signal(symbol, signal_data)
            
            return {
                'signal_id': signal_id,
                'type': 'cambio_regimen',
                'regime': regime_pred,
                'confidence': confidence
            }
        
        return None

# ==================================================================================
# EJEMPLO 4: Integraci√≥n completa en tu main.py o script principal
# ==================================================================================

async def main_nvbot3_con_retroalimentacion():
    """
    Funci√≥n principal que integra todo tu NvBot3 existente 
    con el nuevo sistema de retroalimentaci√≥n
    """
    
    print("ü§ñ Iniciando NvBot3 con Sistema de Retroalimentaci√≥n")
    print("=" * 55)
    
    # Tu configuraci√≥n existente
    symbols = load_symbols_from_config()  # Tu funci√≥n existente
    models = load_trained_models()        # Tu funci√≥n existente
    
    # Nuevo: inicializar generador con tracking
    signal_generator = SignalGenerator()
    
    print(f"üìä Monitoreando {len(symbols)} s√≠mbolos")
    print(f"üåê Dashboard web disponible en: http://localhost:5000")
    
    while True:
        for symbol in symbols:
            try:
                # Tu pipeline existente
                market_data = fetch_market_data(symbol)  # Tu funci√≥n
                features = calculate_features(market_data)  # Tu funci√≥n
                current_price = market_data['close']
                
                # Detectar diferentes tipos de se√±ales
                signals = []
                
                # Momentum
                momentum_signal = signal_generator.detect_momentum(symbol, features, current_price)
                if momentum_signal:
                    signals.append(momentum_signal)
                
                # Rebotes 
                rebound_signal = signal_generator.detect_rebound(symbol, features, current_price)
                if rebound_signal:
                    signals.append(rebound_signal)
                
                # R√©gimen
                regime_signal = signal_generator.detect_regime_change(symbol, features, current_price)
                if regime_signal:
                    signals.append(regime_signal)
                
                # Reportar se√±ales detectadas
                for signal in signals:
                    print(f"üéØ {symbol}: {signal['type']} - Confianza: {signal['confidence']:.2f}")
                    print(f"   üìä Tracking ID: {signal['signal_id']}")
                    print(f"   üåê Ver en dashboard: http://localhost:5000")
                
            except Exception as e:
                print(f"‚ùå Error procesando {symbol}: {e}")
                continue
        
        # Tu intervalo existente
        print(f"‚è∞ Pr√≥ximo an√°lisis en 60 segundos...")
        await asyncio.sleep(60)

# ==================================================================================
# PASOS PARA APLICAR ESTAS MODIFICACIONES
# ==================================================================================

"""
üìã CHECKLIST DE IMPLEMENTACI√ìN:

‚ñ° 1. Completar entrenamiento de modelos
   python scripts/model_trainer.py

‚ñ° 2. Ejecutar integraci√≥n del sistema
   python scripts/integrate_feedback_system.py

‚ñ° 3. Instalar nuevas dependencias
   pip install flask flask-socketio

‚ñ° 4. Modificar tu c√≥digo principal agregando las l√≠neas marcadas arriba

‚ñ° 5. Iniciar el sistema completo
   python scripts/start_nvbot3_with_dashboard.py

‚ñ° 6. Abrir http://localhost:5000 en tu navegador

‚ñ° 7. Dejar correr el sistema y dar retroalimentaci√≥n a las se√±ales

‚ñ° 8. Despu√©s de 100+ feedbacks, el sistema se reentrena autom√°ticamente

üéØ RESULTADO FINAL:
Tu NvBot3 funcionar√° exactamente igual que antes, pero ahora:
- Cada se√±al se guarda autom√°ticamente
- Puedes ver todas las se√±ales en una interfaz web bonita  
- Puedes dar feedback sobre si acert√≥ o fall√≥
- El sistema aprende de tu feedback y mejora autom√°ticamente
- Tienes estad√≠sticas de performance en tiempo real

¬°Es como agregarle memoria a largo plazo a tu bot! üß†
"""